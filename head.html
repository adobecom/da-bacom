<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="preload" href="/styles/styles.css" as="style"/>
<script>
  const libs = (() => {
    const { hostname, search } = window.location;
    if (!['.aem.', '.hlx.', '.stage.', 'local'].some((i) => hostname.includes(i))) return '/libs';
    const branch = new URLSearchParams(search).get('milolibs') || 'main';
    if (branch === 'local') return 'http://localhost:6456/libs';
    if (branch === 'main' && hostname.includes('.stage.')) return '/libs';
    return branch.includes('--') ? `https://${branch}.aem.live/libs` : `https://${branch}--milo--adobecom.aem.live/libs`;
  })();

  const miloStyles = document.createElement('link');
  const miloUtils = document.createElement('link');
  const miloDecorate = document.createElement('link');

  miloStyles.setAttribute('as', 'style');
  miloStyles.setAttribute('href', `${libs}/styles/styles.css`);

  [miloUtils, miloDecorate].forEach((tag) => {
    tag.setAttribute('crossorigin', 'true');
    tag.setAttribute('as', 'script');
  })

  miloUtils.setAttribute('href', `${libs}/utils/utils.js`);
  miloDecorate.setAttribute('href', `${libs}/utils/decorate.js`);

  [miloStyles, miloUtils, miloDecorate].forEach((tag) => tag.setAttribute('rel', 'preload'));
  document.head.append(miloStyles, miloUtils, miloDecorate);

  // example string: ae_ar: ae; ae_en: en; be_en: en-BE
  function parseHrefLangString(str) {
    if (!str) return [];
    return str.split(';').map(langPair => {
      const [locale, lang] = langPair.split(':');
      return { locale: locale.trim(), lang: lang.trim() };
    });
  }

  function buildLink(language, url) {
    const link = document.createElement('link');
    link.setAttribute('rel', 'alternate');
    link.setAttribute('hreflang', language?.toLowerCase());
    link.setAttribute('href', url);
    return link;
  }

  const hrefLangMeta = document.querySelector('meta[name="hreflang"]');
  
  if (hrefLangMeta) {
    const { origin, pathname } = window.location;
    const defaults = [{locale: '', lang: 'x-default'}, {locale: '', lang: 'en-us'}]
    const localeMap = parseHrefLangString(hrefLangMeta.content);
    const pageLocale = localeMap.reduce((rdx, pair) => {
      if (pathname.includes(`/${pair.locale.toLowerCase()}/`)) rdx += pair.locale;
      return rdx;
    }, '');
    const defaultPath = pageLocale ? pathname.replace(`/${pageLocale}`, '') : pathname;
    const xDefault = buildLink('x-default', `${origin}${defaultPath}`);
    const enUs = buildLink('en-us', `${origin}${defaultPath}`);

    const links = localeMap.reduce((rdx, { locale, lang }) => {
      rdx.push(buildLink(lang, `${origin}/${locale}${defaultPath}`))
      return rdx;
    }, []);

    document.head.querySelector('title').after(xDefault, enUs, ...links);
  }  
  document.querySelector('[type="application/ld+json"]').remove();
  const schema = {
    "@context": "https://schema.org",
    "@type": ["WebPage", "WebSite"],
    "url": window.location.href, // url of the page
    "@id": window.location.href, // url of the page
    "name": document.title.split('|')[0], // title of the page
    "inLanguage": window.navigator.language, // language of the page
    "audience": {
      "@type": "Audience",
      "geographicArea": {
        "@type": "AdministrativeArea",
        "address": {
          "@type": "PostalAddress",
          "addressCountry": window.navigator.language.split('-')[1] // set part of ietf, I think
        }
      }
    },
    "isPartOf": {
      "@type": "WebSite",
      "url": "https://business.adobe.com/",
      "name": "Adobe for Business",
      "@id": "https://business.adobe.com/",
      "isPartOf": {
        "@type": "WebSite",
        "url": "https://www.adobe.com",
        "name": "Adobe",
        "@id": "https://www.adobe.com",
        "publisher": {
          "@type": "Corporation",
          "name": "Adobe",
          "@id": "https://www.adobe.com/#organization",
          "sameAs": [
            "https://en.wikipedia.org/wiki/Adobe",
            "https://twitter.com/Adobe",
            "https://www.linkedin.com/company/adobe",
            "https://www.crunchbase.com/organization/adobe-systems"
          ],
          "legalName": "Adobe Inc.",
          "url": "https://www.adobe.com/",
          "brand": [
            {
              "@type": "Brand",
              "name": "Adobe Creative Cloud",
              "alternateName": "Creative Cloud",
              "url": "https://www.adobe.com/&&/creativecloud.html",
              "sameAs": "https://www.wikidata.org/entity/Q14636918"
            },
            {
              "@type": "Brand",
              "name": "Adobe for Business",
              "alternateName": "Experience Cloud",
              "url": "{placeholder}",
              "sameAs": "https://www.wikidata.org/entity/Q16927817"
            },
            {
              "@type": "Brand",
              "name": "Adobe Document Cloud",
              "alternateName": "Document Cloud",
              "url": "https://www.adobe.com/&&/documentcloud.html",
              "sameAs": "https://www.wikidata.org/entity/Q2823478"
            }
          ]
        }
      },
      "mainEntityOfPage": {
        "@type": ["WebPage", "WebSite"],
        "@id": window.location.href // url of the page
      }
    }
  }
  const scriptTag = document.createElement('script');
  scriptTag.setAttribute('type', 'application/ld+json');
  scriptTag.innerText = JSON.stringify(schema);
  document.head.append(scriptTag);

</script>
<script src="/scripts/scripts.js" type="module"></script>
<style>body { display: none; }</style>
<link rel="icon" href="data:,">
