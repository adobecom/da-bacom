<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="preload" href="/styles/styles.css" as="style"/>
<script>
  const libs = (() => {
    const { hostname, search } = window.location;
    if (!['.aem.', '.hlx.', '.stage.', 'local'].some((i) => hostname.includes(i))) return '/libs';
    const branch = new URLSearchParams(search).get('milolibs') || 'main';
    if (branch === 'local') return 'http://localhost:6456/libs';
    if (branch === 'main' && hostname.includes('.stage.')) return '/libs';
    return branch.includes('--') ? `https://${branch}.aem.live/libs` : `https://${branch}--milo--adobecom.aem.live/libs`;
  })();

  const miloStyles = document.createElement('link');
  const miloUtils = document.createElement('link');
  const miloDecorate = document.createElement('link');

  miloStyles.setAttribute('as', 'style');
  miloStyles.setAttribute('href', `${libs}/styles/styles.css`);

  [miloUtils, miloDecorate].forEach((tag) => {
    tag.setAttribute('crossorigin', 'true');
    tag.setAttribute('as', 'script');
  })

  miloUtils.setAttribute('href', `${libs}/utils/utils.js`);
  miloDecorate.setAttribute('href', `${libs}/utils/decorate.js`);

  [miloStyles, miloUtils, miloDecorate].forEach((tag) => tag.setAttribute('rel', 'preload'));
  document.head.append(miloStyles, miloUtils, miloDecorate);

  const personalizationMeta = document.querySelector('meta[name="personalization"]');
  if (personalizationMeta) {
    // Helper to create preload link if it doesn't already exist
    const createPreloadLink = (href, as, crossorigin = 'anonymous') => {
      // Normalize URL to ensure exact match
      const normalizedHref = href.replace(/\/+/g, '/').replace(/^([^:]+):\/([^/])/, '$1://$2');
      const existingLink = document.head.querySelector(`link[rel="preload"][href="${normalizedHref}"]`);
      if (existingLink) return; // Already preloaded
      
      const link = document.createElement('link');
      link.setAttribute('rel', 'preload');
      link.setAttribute('as', as);
      link.setAttribute('crossorigin', crossorigin);
      link.setAttribute('href', normalizedHref);
      document.head.append(link);
    };
    
    // Preload helpers.js - ensure URL matches what utils.js will use
    createPreloadLink(`${libs}/martech/helpers.js`, 'script');
    
    // Preload preview.js - use absolute URL for dynamic imports
    createPreloadLink(`${libs}/features/personalization/preview.js`, 'script');

  }

  function buildLink(language, url) {
    const link = document.createElement('link');
    link.setAttribute('rel', 'alternate');
    link.setAttribute('hreflang', language);
    link.setAttribute('href', url);
    return link;
  }

  const userAgentMeta = document.querySelector('meta[name="hreflinksuseragents"]');
  const allowedAgents = userAgentMeta && userAgentMeta.content.split(',');
  const userAgentString = window.navigator.userAgent;
  const isAllowedAgent = allowedAgents && allowedAgents.some((agent) => userAgentString.includes(agent.trim()));

  const LOCALES = ['ae_ar', 'ae_en', 'africa', 'ar', 'at', 'au', 'be_en', 'be_fr', 'be_nl', 'bg', 'br', 'ca_fr', 'ca', 'ch_de', 'ch_fr', 'ch_it', 'cl', 'cn', 'co', 'cr', 'cy_en', 'cz', 'de', 'dk', 'ec', 'ee', 'eg_ar', 'eg_en', 'el', 'es', 'fi', 'fr', 'gr_el', 'gr_en', 'gt', 'hk_en', 'hk_zh', 'hu', 'id_en', 'id_id', 'ie', 'il_en', 'il_he', 'in_hi', 'in', 'it', 'jp', 'kr', 'kw_ar', 'kw_en', 'la', 'langstore', 'lt', 'lu_de', 'lu_en', 'lu_fr', 'lv', 'mena_ar', 'mena_en', 'mt', 'mx', 'my_en', 'my_ms', 'ng', 'nl', 'no', 'nz', 'pe', 'ph_en', 'ph_fil', 'pl', 'pr', 'pt', 'qa_ar', 'qa_en', 'ro', 'ru', 'sa_ar', 'sa_en', 'se', 'sg', 'si', 'sk', 'th_en', 'th_th', 'tr', 'tw', 'ua', 'uk', 'vn_en', 'vn_vi', 'za'];

  async function fetchAndParseSitemap() {
    const sitemapOrigin = 'https://business.adobe.com';
    const { origin, pathname } = window.location;

    let sitemapPath = '/sitemap.xml';
    const localeMatch = LOCALES.find(locale => pathname.startsWith(`/${locale}/`));

    if (localeMatch) {
      sitemapPath = `/${localeMatch}/sitemap.xml`;
    }
    
    try {
      const response = await fetch(`${origin}${sitemapPath}`);
      if (!response.ok) {
        console.warn('Failed to fetch sitemap:', response.status);
        return;
      }
      
      const xmlText = await response.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
      const parseError = xmlDoc.querySelector('parsererror');
      if (parseError) {
        return;
      }
      
      const urlElements = xmlDoc.querySelectorAll('url');
      let currentUrlElement = null;
      const correctedPath = pathname.includes('html') ? pathname : `${pathname}.html`
      const isLocalRoot = `${sitemapOrigin}/${localeMatch}/` === `${sitemapOrigin}${pathname}`;
      const rootPage = isLocalRoot ? `${sitemapOrigin}/${localeMatch}/` : `${sitemapOrigin}/`; 
      const currentPageUrl = pathname !== '/' && pathname !== `/${localeMatch}/` ? `${sitemapOrigin}${correctedPath}` : `${rootPage}`;

      for (const urlElement of urlElements) {
        const loc = urlElement.querySelector('loc')?.textContent;
        if (loc === currentPageUrl || loc === currentPageUrl.replace(/\/$/, '')) {
          currentUrlElement = urlElement;
          break;
        }
      }
      
      if (!currentUrlElement) {
        console.warn('Current page not found in sitemap');
        return;
      }
      
      const alternateLinks = currentUrlElement.querySelectorAll('link[rel="alternate"]');
      const linkElements = [];

      alternateLinks.forEach(altLink => {
        const hreflang = altLink.getAttribute('hreflang');
        const href = altLink.getAttribute('href');
        
        if (hreflang && href) {
          linkElements.push(buildLink(hreflang, href));
        }
      });
      
       const titleElement = document.head.querySelector('title');
      if (linkElements.length > 0 && titleElement) {
        titleElement.after(...linkElements);
      }
    } catch (error) {
      console.error('Error fetching or parsing sitemap:', error);
    }
  }
  
  if (isAllowedAgent) {
    fetchAndParseSitemap();
  }

  const sheetSchema = document.querySelector('[type="application/ld+json"]');

  const schema = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": 'Adobe for Business', 
    "url": window.location.href 
  }

  const jsonLD = document.createElement('script');
  jsonLD.setAttribute('type', 'application/ld+json');
  jsonLD.innerText = JSON.stringify(schema);
  sheetSchema ? sheetSchema.after(jsonLD) : document.head.append(jsonLD);
</script>
<script src="/scripts/scripts.js" type="module"></script>
<style>body { display: none; }</style>
<link rel="icon" href="data:,">
