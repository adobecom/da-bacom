<!-- npm run test:file "test/tools/generator/landing-page.test.html" -->
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://da.live/nx/styles/nexter.css">
  <script type="importmap">
      {
        "imports": {
          "da-sdk": "./mocks/da-sdk.js",
          "da-fetch": "./mocks/da-fetch.js",
          "constants": "https://da.live/nx/public/utils/constants.js",
          "da-lit": "https://da.live/deps/lit/dist/index.js",
          "styles": "https://da.live/nx/utils/styles.js",
          "svg": "https://da.live/nx/utils/svg.js",
          "components": "https://da.live/nx/public/sl/components.js"
        }
      }
    </script>
</head>

<body>
  <main>
    <da-generator></da-generator>
  </main>
  <script type="module">
    import { runTests } from '@web/test-runner-mocha';
    import { expect } from '@esm-bundle/chai';
    import sinon from 'sinon';
    import DA_SDK from 'da-sdk';
    import { daFetch, initIms } from './mocks/da-fetch.js';
    import { mockFetch, restoreFetch } from './mocks/fetch.js';
    import '../../../tools/generator/landing-page.js';

    const ogLana = window.lana;

    runTests(() => {
      describe('LandingPageForm', () => {
        let clock;
        let generator;
        let shadowRoot;
        let openStub;

        const tick = async (milliseconds) => {
          clock.tick(milliseconds);
          await clock.nextAsync();
          if (generator) await generator.updateComplete;
        };

        beforeEach(async () => {
          window.lana = { log: sinon.spy() };
          clock = sinon.useFakeTimers();
          openStub = sinon.stub(window, 'open');
          mockFetch();

          generator = document.querySelector('da-generator');
          shadowRoot = generator.shadowRoot;

          await tick(100);
        });

        afterEach(() => {
          window.lana = ogLana;
          clock.restore();
          openStub.restore();
          restoreFetch();

          document.querySelectorAll('toast-message').forEach(el => el.remove());
          generator.resetForm();
        });

        it('renders correctly', async () => {
          expect(generator).to.exist;
          expect(initIms.called).to.be.true;

          expect(shadowRoot.querySelector('h1')).to.exist;
          expect(shadowRoot.querySelector('form')).to.exist;
          const h2 = shadowRoot.querySelector('form h2');
          expect(h2.textContent.trim()).to.equal('Core Options');
          expect(shadowRoot.querySelector('path-input').disabled).to.be.true;
          expect(generator.showForm).to.be.false;
        });

        it('has core form fields', async () => {
          const formFields = [
            'contentType',
            'gated',
            'region',
            'marqueeHeadline',
            'pageName'
          ];

          const fields = shadowRoot.querySelectorAll('form [name]');
          const fieldNames = Array.from(fields).map(field => field.getAttribute('name'));
          expect(fieldNames).to.deep.equal(formFields);
        });

        it('handles toast events', () => {
          expect(generator).to.exist;

          const toastEvent = new CustomEvent('show-toast', {
            detail: { message: 'Test toast message', type: 'info', timeout: 5000 }
          });

          document.dispatchEvent(toastEvent);

          const toast = document.querySelector('toast-message');
          expect(toast).to.exist;
          expect(toast.message).to.equal('Test toast message');
          expect(toast.type).to.equal('info');
          expect(toast.timeout).to.equal(5000);
        });

        it('registers all custom elements', () => {
          expect(customElements.get('da-generator')).to.exist;
          expect(customElements.get('image-dropzone')).to.exist;
          expect(customElements.get('multi-select')).to.exist;
          expect(customElements.get('path-input')).to.exist;
          expect(customElements.get('toast-message')).to.exist;
        });

        it('initializes with DA SDK', async () => {
          const sdk = await DA_SDK;
          expect(sdk).to.exist;
          expect(sdk.context.repo).to.equal('adobecom');
          expect(sdk.token).to.equal('mock-token');
        });

        it('uploads mock image', async () => {
          const file = new File(['mock image content'], 'mock-image.jpg', { type: 'image/jpeg' });

          generator.handleImageChange({ detail: { file }, target: { name: 'marqueeImage' } });
          await tick(500);

          expect(daFetch.called).to.be.true;

          const uploadCalls = daFetch.getCalls().filter(call => call.args[1]?.method === 'PUT');
          expect(uploadCalls.length).to.be.greaterThan(0);
          expect(uploadCalls[0].args[0]).to.include('mock-image.jpg');
        });

        it('shows error on submit when required fields are missing', async () => {
          generator.form.contentType = 'Guide';
          generator.form.gated = 'Ungated';

          const form = shadowRoot.querySelector('form');
          const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
          form.dispatchEvent(submitEvent);

          await tick(100);

          expect(generator.missingFields).to.not.deep.equal({});
        });

        const setValue = (name, value) => {
          const element = shadowRoot.querySelector(`[name="${name}"]`);
          element.value = value;
          if (element.matches('sl-select')) {
            element.dispatchEvent(new CustomEvent('change', {
              bubbles: true,
              detail: { value }
            }));
          } else {
            element.dispatchEvent(new Event('input', { bubbles: true }));
          }
        };

        const fillCoreFields = () => {
          setValue('contentType', 'Guide');
          setValue('gated', 'Ungated');
          setValue('region', '/');
          setValue('marqueeHeadline', 'Test Landing Page');
        };

        const setPageName = (pageName = 'test-page') => {
          const pathInput = shadowRoot.querySelector('path-input[name="pageName"]');
          pathInput.value = pageName;

          const fullPath = `${pathInput.prefix}${pageName}`;
          pathInput.dispatchEvent(new CustomEvent('validate-request', {
            bubbles: true,
            detail: { fullPath, value: pageName, name: 'pageName' }
          }));
        };

        it('completes core fields and confirms form', async () => {
          const pathInput = shadowRoot.querySelector('path-input');
          expect(pathInput.disabled).to.be.true;
          expect(generator.showForm).to.be.false;

          fillCoreFields();
          await tick(100);

          expect(generator.form.contentType).to.equal('Guide');
          expect(generator.form.gated).to.equal('Ungated');
          expect(generator.form.region).to.equal('/');
          expect(generator.form.marqueeHeadline).to.equal('Test Landing Page');

          const updatedPathInput = shadowRoot.querySelector('path-input');
          expect(updatedPathInput.disabled).to.be.false;
          expect(updatedPathInput.prefix).to.include('/resources/guide/');

          setPageName();
          await tick(100);

          shadowRoot.querySelector('sl-button.primary').click();
          await tick(100);

          expect(generator.showForm).to.be.true;
          const marqueeSection = shadowRoot.querySelector('[name="marqueeDescription"]');
          expect(marqueeSection).to.exist;
        });

        it('completes all fields and submits successfully', async () => {
          fillCoreFields();
          await tick(100);
          setPageName();
          await tick(100);

          expect(generator.form.url).to.equal('/resources/guide/test-page.html');
          expect(generator.form.pageName).to.equal('test-page');

          shadowRoot.querySelector('sl-button.primary').click();
          await tick(100);

          setValue('marqueeDescription', 'Test description');
          setValue('bodyDescription', '<p>Test body</p>');
          setValue('cardTitle', 'Test Card');
          setValue('cardDescription', 'Test card desc');
          setValue('seoMetadataTitle', 'Test SEO');
          setValue('seoMetadataDescription', 'Test SEO desc');
          setValue('primaryProductName', 'adobe-analytics');
          setValue('experienceFragment', '/fragments/resources/cards/thank-you-collections/advertising');

          generator.form.marqueeImage = { url: '/test/tools/generator/mocks/mock-image.jpg', name: 'mock-image.jpg' };
          generator.form.cardImage = { url: '/test/tools/generator/mocks/mock-image.jpg', name: 'mock-image.jpg' };
          generator.form.pdfAsset = { url: 'https://main--da-bacom--adobecom.hlx.page/test.pdf', name: 'test.pdf' };

          expect(generator.isFormComplete()).to.be.true;

          shadowRoot.querySelector('sl-button[type="submit"]').click();
          // Wait for the preview call to be made
          for (let i = 0; i < 10; i++) {
            await tick(500);
          }

          const fetchCalls = window.fetch.getCalls();
          const previewCall = fetchCalls.find(call => call.args[0].includes('/resources/guide/test-page'));
          expect(previewCall).to.exist;
          expect(previewCall.args[1]?.method).to.equal('POST');

          expect(openStub.calledOnce).to.be.true;
          expect(openStub.firstCall.args[0]).to.include('business.stage.adobe.com');
          expect(openStub.firstCall.args[1]).to.equal('_blank');
        });

        it('shows error when required field is missing', async () => {
          fillCoreFields();
          setPageName();
          await tick(100);

          shadowRoot.querySelector('sl-button.primary').click();
          await tick(100);

          setValue('cardTitle', '');

          shadowRoot.querySelector('sl-button[type="submit"]').click();
          await tick(100);

          expect(generator.missingFields.cardTitle).to.be.true;
        });

        it('requires marketo fields for gated forms', async () => {
          setValue('contentType', 'Guide');
          setValue('gated', 'Gated');
          setValue('region', '/');
          setValue('marqueeHeadline', 'Test');

          setPageName('test');
          await tick(100);

          shadowRoot.querySelector('sl-button.primary').click();
          await tick(100);

          shadowRoot.querySelector('sl-button[type="submit"]').click();
          await tick(100);

          const missingFields = Object.keys(generator.missingFields).filter(
            key => generator.missingFields[key]
          );
          expect(missingFields).to.include('formTemplate');
          expect(missingFields).to.include('campaignId');
          expect(missingFields).to.include('marketoPOI');
        });

        it('isEmpty correctly identifies empty values', () => {
          const testCases = [
            { input: '', expected: true, description: 'empty string' },
            { input: '   ', expected: true, description: 'whitespace only string' },
            { input: '<p></p>', expected: true, description: 'empty HTML tags' },
            { input: '<p>   </p>', expected: true, description: 'HTML with whitespace' },
            { input: 'Content', expected: false, description: 'non-empty string' },
            { input: '<p>Content</p>', expected: false, description: 'HTML with content' },
            { input: [], expected: true, description: 'empty array' },
            { input: ['item'], expected: false, description: 'non-empty array' },
            { input: null, expected: true, description: 'null' },
            { input: undefined, expected: true, description: 'undefined' },
            { input: 0, expected: true, description: 'zero' },
            { input: false, expected: true, description: 'false' },
            { input: 1, expected: false, description: 'non-zero number' },
            { input: true, expected: false, description: 'true' },
            { input: {}, expected: true, description: 'empty object' },
            { input: { url: '', name: '' }, expected: true, description: 'object with empty values' },
            { input: { url: 'test.jpg', name: '' }, expected: false, description: 'object with some non-empty values' },
            { input: { url: 'test.jpg', name: 'test' }, expected: false, description: 'object with non-empty values' }
          ];

          testCases.forEach(({ input, expected, description }) => {
            const result = generator.isEmpty(input);
            expect(result).to.equal(expected, `Failed for ${description}: expected ${expected} but got ${result}`);
          });
        });
      });
    });
  </script>
</body>

</html>
